# 地圖讀取系統設計文檔

## 概述

地圖（關卡）是一個 JSON 檔案，定義了一場戰鬥的初始配置。透過地圖系統，可以：
- 設計不同難度的關卡
- 創建特定的訓練場景
- 儲存和分享關卡配置

---

## JSON 格式規範

### 完整範例

```json
{
  "name": "四人圍攻",
  "description": "標準訓練關卡：4個不同類型的玩家圍攻 Boss",

  "room": {
    "size": 10.0
  },

  "agent": {
    "position": [5.0, 5.0],
    "angle": 0.0,
    "health": 500.0
  },

  "monsters": [
    {
      "position": [2.0, 2.0],
      "angle": 0.785,
      "health": 100.0,
      "behavior": {
        "type": "berserker",
        "attack_damage": 15.0,
        "attack_range": 3.0,
        "sprint_threshold": 5.0
      }
    },
    {
      "position": [8.0, 2.0],
      "angle": 2.356,
      "health": 80.0,
      "behavior": {
        "type": "hit_and_run",
        "attack_damage": 12.0,
        "flee_distance": 6.0
      }
    },
    {
      "position": [2.0, 8.0],
      "angle": -0.785,
      "health": 100.0,
      "behavior": {
        "type": "orbit_melee",
        "target_radius": 2.5,
        "clockwise": true
      }
    },
    {
      "position": [8.0, 8.0],
      "angle": -2.356,
      "health": 60.0,
      "behavior": {
        "type": "orbit_ranged",
        "weapon_type": "bow",
        "target_radius": 6.0
      }
    }
  ],

  "blood_packs": [
    { "position": [5.0, 8.0] },
    { "position": [5.0, 2.0] }
  ]
}
```

---

## 欄位說明

### room（房間）

| 欄位 | 類型 | 預設值 | 說明 |
|-----|------|--------|------|
| `size` | float | 10.0 | 房間邊長（正方形）|

### agent（Boss / AI 控制）

| 欄位 | 類型 | 預設值 | 說明 |
|-----|------|--------|------|
| `position` | [x, y] | [5.0, 5.0] | 初始位置 |
| `angle` | float | 0.0 | 初始朝向（弧度，0=右）|
| `health` | float | 500.0 | 初始血量 |

### monsters（真人玩家 / 敵人）

陣列，每個元素：

| 欄位 | 類型 | 預設值 | 說明 |
|-----|------|--------|------|
| `position` | [x, y] | 必填 | 初始位置 |
| `angle` | float | 0.0 | 初始朝向 |
| `health` | float | 100.0 | 初始血量 |
| `behavior` | object | stationary | 行為配置 |

### behavior（行為配置）

| 類型 | 參數 |
|-----|------|
| `stationary` | `attack_damage`, `attack_range`, `attack_cooldown_ticks` |
| `berserker` | `attack_damage`, `attack_range`, `sprint_threshold` |
| `hit_and_run` | `attack_damage`, `flee_distance`, `safe_distance`, `flee_duration` |
| `orbit_melee` | `attack_damage`, `target_radius`, `radius_tolerance`, `clockwise` |
| `orbit_ranged` | `weapon_type`("bow"/"staff"), `target_radius`, `danger_radius`, `clockwise` |

### blood_packs（血包）

陣列，每個元素：

| 欄位 | 類型 | 預設值 | 說明 |
|-----|------|--------|------|
| `position` | [x, y] | 必填 | 初始位置 |

---

## 程式碼架構

### 檔案結構

```
game/
├── map_loader.py      # MapLoader 類別
└── world.py           # 修改 reset() 支援地圖載入
```

### MapLoader 類別

```python
# game/map_loader.py

import json
from pathlib import Path
from dataclasses import dataclass, field
from typing import List, Dict, Any, Optional

from game.behaviors import BehaviorRegistry


@dataclass
class MonsterConfig:
    """Monster 配置"""
    position: List[float]
    angle: float = 0.0
    health: float = 100.0
    behavior: Dict[str, Any] = field(default_factory=lambda: {"type": "stationary"})


@dataclass
class BloodPackConfig:
    """血包配置"""
    position: List[float]


@dataclass
class MapConfig:
    """完整地圖配置"""
    name: str = "Unnamed"
    description: str = ""
    room_size: float = 10.0
    agent_position: List[float] = field(default_factory=lambda: [5.0, 5.0])
    agent_angle: float = 0.0
    agent_health: float = 500.0
    monsters: List[MonsterConfig] = field(default_factory=list)
    blood_packs: List[BloodPackConfig] = field(default_factory=list)


class MapLoader:
    """地圖載入器"""

    @staticmethod
    def load(path: str) -> MapConfig:
        """
        從 JSON 檔案載入地圖配置

        Args:
            path: JSON 檔案路徑

        Returns:
            MapConfig 物件
        """
        with open(path, 'r', encoding='utf-8') as f:
            data = json.load(f)

        return MapLoader.from_dict(data)

    @staticmethod
    def from_dict(data: Dict[str, Any]) -> MapConfig:
        """從字典建立 MapConfig"""
        config = MapConfig()

        # 基本資訊
        config.name = data.get("name", "Unnamed")
        config.description = data.get("description", "")

        # 房間
        room = data.get("room", {})
        config.room_size = room.get("size", 10.0)

        # Agent
        agent = data.get("agent", {})
        config.agent_position = agent.get("position", [5.0, 5.0])
        config.agent_angle = agent.get("angle", 0.0)
        config.agent_health = agent.get("health", 500.0)

        # Monsters
        for m in data.get("monsters", []):
            monster = MonsterConfig(
                position=m["position"],
                angle=m.get("angle", 0.0),
                health=m.get("health", 100.0),
                behavior=m.get("behavior", {"type": "stationary"})
            )
            config.monsters.append(monster)

        # Blood packs
        for bp in data.get("blood_packs", []):
            config.blood_packs.append(BloodPackConfig(position=bp["position"]))

        return config

    @staticmethod
    def save(config: MapConfig, path: str) -> None:
        """
        儲存地圖配置到 JSON 檔案

        Args:
            config: MapConfig 物件
            path: 輸出路徑
        """
        data = MapLoader.to_dict(config)
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(data, f, indent=2, ensure_ascii=False)

    @staticmethod
    def to_dict(config: MapConfig) -> Dict[str, Any]:
        """將 MapConfig 轉為字典"""
        return {
            "name": config.name,
            "description": config.description,
            "room": {
                "size": config.room_size
            },
            "agent": {
                "position": config.agent_position,
                "angle": config.agent_angle,
                "health": config.agent_health
            },
            "monsters": [
                {
                    "position": m.position,
                    "angle": m.angle,
                    "health": m.health,
                    "behavior": m.behavior
                }
                for m in config.monsters
            ],
            "blood_packs": [
                {"position": bp.position}
                for bp in config.blood_packs
            ]
        }

    @staticmethod
    def validate(config: MapConfig) -> List[str]:
        """
        驗證地圖配置

        Returns:
            錯誤訊息列表（空列表表示有效）
        """
        errors = []

        # 檢查房間大小
        if config.room_size <= 0:
            errors.append("房間大小必須大於 0")

        # 檢查 Agent 位置
        ax, ay = config.agent_position
        if not (0 < ax < config.room_size and 0 < ay < config.room_size):
            errors.append(f"Agent 位置 {config.agent_position} 超出房間範圍")

        # 檢查 Monster 位置和行為
        for i, m in enumerate(config.monsters):
            mx, my = m.position
            if not (0 < mx < config.room_size and 0 < my < config.room_size):
                errors.append(f"Monster {i} 位置 {m.position} 超出房間範圍")

            behavior_type = m.behavior.get("type", "stationary")
            if behavior_type not in BehaviorRegistry.list_types():
                errors.append(f"Monster {i} 未知行為類型: {behavior_type}")

        # 檢查血包位置
        for i, bp in enumerate(config.blood_packs):
            bx, by = bp.position
            if not (0 < bx < config.room_size and 0 < by < config.room_size):
                errors.append(f"血包 {i} 位置 {bp.position} 超出房間範圍")

        return errors
```

---

## GameWorld 整合

### 修改 reset() 方法

```python
# game/world.py

class GameWorld:
    def __init__(self, room: Optional[Room] = None, map_config: Optional[MapConfig] = None):
        self._map_config = map_config

        if map_config:
            self.room = Room(size=map_config.room_size)
        else:
            self.room = room or Room()

        # ... 其他初始化 ...

    def reset(self) -> None:
        """Reset the world to initial state."""
        self.entities.clear()
        self.monsters.clear()
        self.items.clear()
        self.tick_count = 0

        EntityFactory.reset_id_counter()
        self.projectile_manager.clear()

        if self._map_config:
            self._reset_from_map()
        else:
            self._reset_default()

        self.event_bus.publish(GameEvent(
            EventType.EPISODE_START,
            data={'tick': 0}
        ))

    def _reset_from_map(self) -> None:
        """根據地圖配置重置"""
        config = self._map_config

        # 建立 Agent
        px, py = config.agent_position
        self.player = EntityFactory.create_player(px, py)
        self.player.position.angle = config.agent_angle
        self.player.health.maximum = config.agent_health
        self.player.health.current = config.agent_health
        self.entities.append(self.player)

        # 建立 Monsters
        for m in config.monsters:
            behavior = BehaviorRegistry.from_dict(m.behavior)
            monster = EntityFactory.create_monster(
                x=m.position[0],
                y=m.position[1],
                health=m.health,
                movement_behavior=behavior
            )
            monster.position.angle = m.angle
            self.monsters.append(monster)
            self.entities.append(monster)

        # 建立血包
        for bp in config.blood_packs:
            blood = EntityFactory.create_blood_pack(bp.position[0], bp.position[1])
            self.items.append(blood)
            self.entities.append(blood)

    def _reset_default(self) -> None:
        """使用預設配置重置（現有邏輯）"""
        # ... 現有的 reset 邏輯 ...

    def load_map(self, path: str) -> None:
        """載入地圖並重置"""
        self._map_config = MapLoader.load(path)
        self.room = Room(size=self._map_config.room_size)
        self.reset()
```

---

## 使用範例

### 載入地圖

```python
from game.world import GameWorld
from game.map_loader import MapLoader

# 方法 1: 建立時指定地圖
config = MapLoader.load("maps/level_01.json")
world = GameWorld(map_config=config)
world.reset()

# 方法 2: 執行時載入
world = GameWorld()
world.load_map("maps/level_02.json")
```

### 創建地圖

```python
from game.map_loader import MapLoader, MapConfig, MonsterConfig, BloodPackConfig

config = MapConfig(
    name="簡單測試",
    room_size=10.0,
    agent_position=[5.0, 5.0],
    monsters=[
        MonsterConfig(
            position=[2.0, 2.0],
            health=100.0,
            behavior={"type": "berserker", "attack_damage": 10.0}
        )
    ],
    blood_packs=[
        BloodPackConfig(position=[8.0, 8.0])
    ]
)

# 驗證
errors = MapLoader.validate(config)
if errors:
    print("地圖配置錯誤:", errors)
else:
    MapLoader.save(config, "maps/test.json")
```

---

## 預設地圖集

### maps/default.json（標準訓練）

4 種不同行為的 Monster，1 個血包。

### maps/archer_hell.json（弓箭地獄）

4 個遠程弓箭手，訓練閃避投射物。

### maps/melee_rush.json（近戰衝鋒）

4 個 Berserker，訓練走位和反擊。

### maps/solo_duel.json（單挑）

1 個高血量 Monster，訓練 1v1 技巧。

---

## 訓練整合

### 隨機地圖訓練

```python
import random
from pathlib import Path

class Trainer:
    def __init__(self, map_folder: str = "maps/"):
        self.map_files = list(Path(map_folder).glob("*.json"))

    def run_episode(self):
        # 每個 episode 隨機選擇地圖
        map_path = random.choice(self.map_files)
        self.world.load_map(str(map_path))

        # ... 訓練邏輯 ...
```

### 課程學習（Curriculum Learning）

```python
class CurriculumTrainer:
    def __init__(self):
        self.curriculum = [
            ("maps/solo_duel.json", 1000),      # 1v1 訓練 1000 episodes
            ("maps/melee_rush.json", 2000),     # 近戰衝鋒 2000 episodes
            ("maps/archer_hell.json", 2000),    # 弓箭地獄 2000 episodes
            ("maps/default.json", 5000),        # 綜合訓練 5000 episodes
        ]

    def get_map_for_episode(self, episode: int) -> str:
        total = 0
        for map_path, count in self.curriculum:
            total += count
            if episode < total:
                return map_path
        return self.curriculum[-1][0]
```

---

## 測試方法

```python
def test_map_loader():
    # 測試載入
    config = MapLoader.load("maps/default.json")
    assert config.room_size == 10.0
    assert len(config.monsters) == 4

    # 測試驗證
    errors = MapLoader.validate(config)
    assert len(errors) == 0

    # 測試儲存和重新載入
    MapLoader.save(config, "maps/temp.json")
    config2 = MapLoader.load("maps/temp.json")
    assert config.name == config2.name


def test_world_with_map():
    config = MapLoader.load("maps/default.json")
    world = GameWorld(map_config=config)
    world.reset()

    assert world.player is not None
    assert len(world.monsters) == len(config.monsters)
    assert len(world.items) == len(config.blood_packs)
```
