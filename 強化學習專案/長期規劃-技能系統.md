# 技能系統設計文檔

## 概述

本文檔詳細說明 Agent（Boss）的 8 個技能的實作細節，包含程式碼架構、類別設計、以及每個技能的具體實現邏輯。

---

## 實作進度

### Phase 2 已完成 (2026-02-08)

已實作前 3 個技能的基礎功能：

| 技能 | 離散動作 | 形狀類型 | 瞄準 Actor | 狀態 |
|------|---------|----------|-----------|------|
| 外圈刮 | 3 | RING | 無 | ✅ 已完成 |
| 飛彈 | 4 | PROJECTILE | aim_actor[0] | ✅ 已完成 |
| 鐵錘 | 5 | RECTANGLE | aim_actor[1] | ✅ 已完成 |

**主要變更：**

1. **新增 `SkillShapeType` 枚舉** (`game/skills.py`)
   - `CONE`: 扇形（原有 basic_attack）
   - `RING`: 環形（外圈刮）
   - `RECTANGLE`: 長方形（鐵錘）
   - `PROJECTILE`: 投射物（飛彈）

2. **擴展 `SkillConfig`** (`game/player.py`)
   - 新增 `shape_type: SkillShapeType`
   - 新增 `aim_actor_index: int` (-1=無需瞄準, 0=aim_missile, 1=aim_hammer)

3. **修改 `SkillExecutor`** (`game/skills.py`)
   - `_check_hit_by_shape()`: 根據形狀類型分派判定
   - `_check_ring_hit()`: 環形判定
   - `_check_rectangle_hit()`: 長方形判定（末端加傷）
   - `_handle_projectile_skill()`: 生成投射物，不直接給獎勵

4. **擴展 `ProjectileManager`** (`game/projectile.py`)
   - 新增 `SKILL_MISSILE` 投射物類型
   - `update()` 支援玩家投射物命中怪物
   - 命中怪物時發布 `SKILL_CAST_COMPLETE` 事件

5. **擴展 Agent 動作空間** (`ai/agent.py`)
   - 離散動作: 4 → 6 個
   - 連續 Actor: 1 → 2 個 (`aim_missile`, `aim_hammer`)

6. **更新渲染器** (`rendering/pygame_renderer.py`)
   - 環形範圍視覺化
   - 長方形範圍視覺化（末端高亮）
   - 投射物瞄準線

7. **BUG 修復：飛彈撞牆不再給獎勵**
   - 投射物技能完成時不發布 `SKILL_CAST_COMPLETE`
   - 只有當投射物實際命中怪物時才給獎勵

### 待實作

- Phase 3: 閃現、血池
- Phase 4: 靈魂爪、靈魂掌
- Phase 5: 召喚血包
- CD 系統（共享 CD + 獨立 CD）

---

## 技能總覽

| ID  | 技能名稱 | 範圍類型   | 可移動 | 需要瞄準 | Actor 數量 |
| --- | ---- | ------ | --- | ---- | -------- |
| 1   | 外圈刮  | 環形 AOE | ✅   | ❌    | 0        |
| 2   | 飛彈   | 直線投射物  | ❌   | ✅    | 1        |
| 3   | 鐵錘   | 長方形/距離  | ✅   | ✅    | 1        |
| 4   | 閃現   | 位移     | -   | ✅    | 2        |
| 5   | 靈魂爪  | 長方形拉人  | ❌   | ✅    | 1        |
| 6   | 靈魂掌  | 長方形推人  | ❌   | ✅    | 1        |
| 7   | 血池   | 原地 AOE | ✅   | ❌    | 0        |
| 8   | 召喚血包 | 無傷害    | ❌   | ❌    | 0        |

**連續 Actor 總數：6 個**

---

## 各技能詳細設計

### 1. 外圈刮 (Outer Slash)

**概念**：環形 AOE，只打 3.0 ≤ 距離 ≤ 4.5 的目標

**參數**：

```python
skill_id = 1
cooldown_ticks = 30        # 約 6 秒
wind_up_ticks = 10         # 約 2 秒前搖
can_move_during_wind_up = True
requires_aim = False
base_damage = 30.0
inner_radius = 3.0
outer_radius = 4.5
```


**Agent 策略提示**：

- 需要走位到與敵人保持 3-4.5 距離
- 可以邊移動邊施放，調整位置
- 多個敵人聚集時效益最大

---

### 2. 飛彈 (Missile)

**概念**：直線投射物，有飛行時間，需要預判

**參數**：

```python
skill_id = 2
cooldown_ticks = 25        # 約 5 秒
wind_up_ticks = 5          # 約 1 秒前搖
can_move_during_wind_up = False
requires_aim = True
aim_actor_count = 1        # aim_actor_missile
base_damage = 40.0
projectile_speed = 1.5     # 每 tick 移動距離
projectile_radius = 0.5    # 碰撞半徑
max_range = 15.0           # 最大射程
```

**瞄準 Actor 輸出**：

- `aim_values[0]`：角度偏移 (弧度)，範圍 [-π, π]
- 最終發射角度 = `caster_angle + aim_values[0]`


**Agent 策略提示**：

- 需要預判敵人移動方向
- 施放時無法移動，需要選擇安全時機
- 適合遠距離風箏

---

### 3. 鐵錘 (Hammer)

**概念**：長條形範圍，末端傷害更高

**參數**：

```python
skill_id = 3
cooldown_ticks = 35        # 約 7 秒
wind_up_ticks = 15         # 約 3 秒前搖
can_move_during_wind_up = True
requires_aim = True
aim_actor_count = 1        # aim_actor_hammer
base_damage = 25.0         # 近端傷害
tip_damage = 50.0          # 末端傷害
min_range = 1.0
max_range = 5.0
tip_range_start = 4.0      # 末端範圍起點
```

**傷害計算**：

```
if distance < tip_range_start:
    damage = base_damage
else:
    damage = tip_damage
```


**Agent 策略提示**：

- 風險收益權衡：追求末端高傷 vs 確保命中
- 可以邊移動邊調整瞄準
- 適合對付逃跑的敵人

---

### 4. 閃現 (Dash)

**概念**：固定距離位移，需要選擇方向和朝向

**參數**：

```python
skill_id = 4
cooldown_ticks = 40        # 約 8 秒
wind_up_ticks = 0          # 無前搖
can_move_during_wind_up = False  # N/A
requires_aim = True
aim_actor_count = 2        # aim_actor_dash_direction, aim_actor_dash_facing
dash_distance = 3.0        # 閃現距離
```

**瞄準 Actor 輸出**：

- `aim_values[0]`：閃現方向角度（相對於當前朝向）
- `aim_values[1]`：閃現後的朝向角度（相對於當前朝向）



**Agent 策略提示**：

- 閃現進場：衝進敵人群 + 立刻放外圈刮/血池
- 閃現逃跑：離開危險區域
- 閃現後朝向很重要：決定下一個技能的瞄準起點

---

### 5. 靈魂爪 (Soul Claw)

**概念**：長方形範圍，將敵人拉向自己

**參數**：

```python
skill_id = 5
cooldown_ticks = 35        # 約 7 秒
wind_up_ticks = 8          # 約 1.6 秒前搖
can_move_during_wind_up = False
requires_aim = True
aim_actor_count = 1        # aim_actor_claw
base_damage = 20.0
range_length = 6.0         # 長方形長度
range_width = 2.0          # 長方形寬度
pull_distance = 3.0        # 拉動距離
```



**Agent 策略提示**：

- 將分散的敵人拉到一起 → 外圈刮 combo
- 將遠程敵人拉近，進入近戰範圍
- 不能移動，需要選擇安全時機

---

### 6. 靈魂掌 (Soul Palm)

**概念**：長方形範圍，將敵人推離自己（靈魂爪的對偶）

**參數**：

```python
skill_id = 6
cooldown_ticks = 35        # 約 7 秒
wind_up_ticks = 8          # 約 1.6 秒前搖
can_move_during_wind_up = False
requires_aim = True
aim_actor_count = 1        # aim_actor_palm
base_damage = 20.0
range_length = 6.0
range_width = 2.0
push_distance = 3.0        # 推動距離
```



**Agent 策略提示**：

- 將敵人推到牆角 → 限制敵人走位
- 創造空間逃脫包圍
- 與靈魂爪配合：拉近 → 打 → 推開

---

### 7. 血池 (Blood Pool)

**概念**：沉入血池無敵，蹦出時 AOE 傷害。沉入血池時無法施放其他技能。

**參數**：

```python
skill_id = 7
cooldown_ticks = 40        # 約 8 秒
wind_up_ticks = 0          # 立即沉入
pool_duration_ticks = 15   # 在血池中的時間（約 3 秒）
can_move_during_wind_up = True  # 血池中可移動
requires_aim = False
emerge_damage = 35.0       # 蹦出傷害
emerge_radius = 2.5        # 蹦出傷害半徑
```

**狀態機**：

```
NORMAL → (施放) → IN_POOL → (時間到) → EMERGE → NORMAL
           │                    │
           └── 無敵、可移動 ──┘
```



**Agent 策略提示**：

- 被圍毆時沉入血池躲避
- 血池中移動到敵人聚集處
- 蹦出時造成範圍傷害
- 攻防一體的核心技能

---

### 8. 召喚血包 (Summon Blood Pack)

**概念**：在場地隨機位置生成 3 個血包

**參數**：

```python
skill_id = 8
cooldown_ticks = 50        # 約 10 秒
wind_up_ticks = 10         # 約 2 秒前搖
can_move_during_wind_up = False  # 施放時無法移動（高風險）
requires_aim = False
pack_count = 3
heal_amount_per_pack = 30.0
```


**Agent 策略提示**：

- 低血量時使用
- 施放時無法移動，需要安全時機
- 放完後要規劃吃血包路線
- 召喚有 +3 獎勵，鼓勵使用

---

## 技能執行器


---

## 與 Agent 的整合

### 動作空間修改


### 技能與 Actor 的映射

```python
SKILL_AIM_MAPPING = {
    # skill_id: [aim_actor_indices]
    1: [],           # 外圈刮 - 無需瞄準
    2: [0],          # 飛彈 - aim_actor_missile
    3: [1],          # 鐵錘 - aim_actor_hammer
    4: [2, 3],       # 閃現 - dash_direction, dash_facing
    5: [4],          # 靈魂爪 - aim_actor_claw
    6: [5],          # 靈魂掌 - aim_actor_palm
    7: [],           # 血池 - 無需瞄準
    8: [],           # 召喚血包 - 無需瞄準
}
```

---

## 測試計畫

### 單元測試

1. **技能範圍判定測試**
   
   - 外圈刮的環形範圍
   - 鐵錘的長方形範圍
   - 靈魂爪/掌的長方形範圍

2. **CD 系統測試**
   
   - 獨立 CD 正確計時
   - 共享 CD 阻止連招

3. **位移效果測試**
   
   - 閃現的位置和朝向
   - 靈魂爪的拉動
   - 靈魂掌的推動

### 整合測試

1. **技能連招測試**
   
   - 靈魂爪 → 外圈刮 combo
   - 閃現 → 血池 combo

2. **與 Agent 的整合**
   
   - 離散動作正確觸發技能
   - 瞄準 Actor 正確影響技能方向

---

## 實作優先級

1. **Phase 1**: 基礎架構
   
   - SkillDefinition 基類
   - SkillRegistry
   - CooldownManager
   - SkillExecutor 框架

2. **Phase 2**: 簡單技能
   
   - 外圈刮（純距離判定）
   - 召喚血包（無傷害）

3. **Phase 3**: 瞄準技能
   
   - 飛彈（直線投射物）
   - 鐵錘（長方形範圍）

4. **Phase 4**: 位移技能
   
   - 閃現
   - 血池

5. **Phase 5**: 控制技能

   - 靈魂爪
   - 靈魂掌

---

## 開發者模式操作

開發者模式（`python main.py --dev`）用於手動控制玩家來 debug 遊戲邏輯。

### 設計理念

- **時間靜止**：除非有輸入，遊戲世界完全靜止，給人類充足時間思考
- **架構一致**：`鍵盤 → Player → World`，與 `Agent → Player → World` 共用 Player 層
- **非法操作在 Player 層擋下**：例如 wind-up 期間無法移動，無論輸入來自 Agent 還是鍵盤

### 基本操作

| 按鍵 | 動作 |
|------|------|
| W | 前進 |
| A | 左轉 |
| D | 右轉 |
| P | 空過（跳過一個 tick）|
| 1-8 | 施放對應技能 |
| R | 重置世界 |
| ESC | 離開 |

**滑鼠**：控制瞄準方向

### 多瞄準器操作（連續點擊方案）

對於需要多個瞄準值的技能，使用「連續點擊」方案：

以閃現（2 個瞄準器）為例：
1. 按 `4`（閃現鍵）→ 進入瞄準模式，遊戲靜止
2. 滑鼠移動到想要的閃現方向，左鍵點擊 → 設定 `aim_1`（閃現方向）
3. 滑鼠移動到想要的閃現後朝向，左鍵點擊 → 設定 `aim_2`（閃現後朝向）
4. 技能自動執行，遊戲推進一個 tick

### 各技能操作流程

| 技能 | 瞄準數 | 操作流程 |
|------|--------|----------|
| 外圈刮 | 0 | 按 1 → 直接執行 |
| 飛彈 | 1 | 按 2 → 點擊設定方向 → 執行 |
| 鐵錘 | 1 | 按 3 → 點擊設定方向 → 執行 |
| 閃現 | 2 | 按 4 → 點擊設定方向 → 點擊設定朝向 → 執行 |
| 靈魂爪 | 1 | 按 5 → 點擊設定方向 → 執行 |
| 靈魂掌 | 1 | 按 6 → 點擊設定方向 → 執行 |
| 血池 | 0 | 按 7 → 直接執行 |
| 召喚血包 | 0 | 按 8 → 直接執行 |

### 實作備註

當實作多瞄準技能時，需在 `dev_mode.py` 中新增：

```python
class AimingState:
    """追蹤多瞄準器的輸入狀態"""
    skill_id: Optional[str]          # 正在瞄準的技能
    required_aims: int               # 需要的瞄準數量
    collected_aims: List[float]      # 已收集的瞄準值
```

並修改 `_wait_for_input` 區分：
- **正常模式**：等待鍵盤輸入
- **瞄準模式**：等待滑鼠點擊，每次點擊收集一個瞄準值
